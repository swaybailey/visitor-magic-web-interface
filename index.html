<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visitor Magic</title>

  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }

    header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    header h1 {
      flex: 1;
      margin: 0;
      font-size: 24px;
      text-align: center;
    }

    header a, .header-plus {
      text-decoration: none;
      font-size: 20px;
      margin: 0 8px;
    }

    .header-plus {
      margin-left: auto;
    }

    .controls {
      margin-bottom: 16px;
    }

    .controls label {
      font-weight: bold;
      display: block;
      margin-top: 8px;
    }

    input[type="date"] {
      width: 150px;
      padding: 6px;
      font-size: 16px;
    }

    input[type="text"], textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      font-size: 16px;
      display: block;
    }

    .visitor {
      background: white;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .visitor-info {
      flex: 1;
    }

    .children {
      color: red;
      font-size: 13px;
      margin-top: 4px;
    }

    .sms-enabled {
      background: #47b80f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 8px 10px;
    }

    .sms-disabled {
      background: #ccc;
      color: #666;
      border: none;
      border-radius: 4px;
      padding: 8px 10px;
    }

    /* login UI */
    #loginBox {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
    }

    #userInfo {
      font-size: 14px;
      margin-top: 8px;
      color: #333;
    }

    #signOutBtn {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }
  </style>
</head>

<body>

<header>
  <a href="https://docs.google.com/spreadsheets/d/1HRd1uKlvqqRveJN7SCdYh9IOu8cU0ygRaMYEG3XL6eQ/edit?gid=671174622"
     target="_blank" title="Open original sheet">ðŸ“„</a>
  <h1>Visitor Magic</h1>
  <a href="addcontact.html" class="header-plus" title="Add Contact">âž•</a>
</header>

<!-- ======= LOGIN BOX ======= -->
<div id="loginBox">
  <div id="g_id_onload"
       data-client_id="651012310033-dbj2vvf3evf9aomj577621ddhked2uvn.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>

  <div class="g_id_signin"
       data-type="standard"
       data-shape="rectangular"
       data-theme="outline"
       data-text="signin_with"
       data-size="large"
       data-logo_alignment="left">
  </div>

  <div id="userInfo" style="display:none;"></div>
  <button id="signOutBtn" style="display:none;">Sign out</button>
</div>

<div class="controls" id="appControls" style="display:none;">
  <label for="datePicker">Date</label>
  <input type="date" id="datePicker">

  <label for="greeting">Greeting</label>
  <input type="text" id="greeting">

  <label for="message">Message</label>
  <textarea id="message" rows="4"></textarea>
</div>

<div id="visitorList"></div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
/* =========================================================
   GOOGLE LOGIN
========================================================= */
let userEmail = null;

function decodeJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
  return JSON.parse(jsonPayload);
}

function handleCredentialResponse(response) {
  const payload = decodeJwt(response.credential);
  userEmail = payload.email;

  document.getElementById("userInfo").style.display = "block";
  document.getElementById("userInfo").innerHTML =
    `<b>Signed in:</b> ${payload.name || ""}<br><b>Email:</b> ${payload.email}`;

  document.getElementById("signOutBtn").style.display = "inline-block";
  document.getElementById("appControls").style.display = "block";

  localStorage.setItem("vm_signed_in", "yes");
  localStorage.setItem("vm_user_email", userEmail);

  loadVisitors();
}

document.getElementById("signOutBtn").addEventListener("click", () => {
  localStorage.removeItem("vm_signed_in");
  localStorage.removeItem("vm_user_email");

  document.getElementById("userInfo").style.display = "none";
  document.getElementById("signOutBtn").style.display = "none";
  document.getElementById("appControls").style.display = "none";
  document.getElementById("visitorList").innerHTML = "";

  alert("Signed out. Refresh page to sign in again.");
});

window.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("vm_signed_in") === "yes") {
    userEmail = localStorage.getItem("vm_user_email");
    document.getElementById("userInfo").style.display = "block";
    document.getElementById("userInfo").innerHTML =
      `<b>Signed in:</b> ${userEmail || "(unknown)"}`;

    document.getElementById("signOutBtn").style.display = "inline-block";
    document.getElementById("appControls").style.display = "block";
  }
});
</script>

<script>
/* ================= CONFIG ================= */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1HRd1uKlvqqRveJN7SCdYh9IOu8cU0ygRaMYEG3XL6eQ/edit?gid=671174622";

/* ================= HELPERS ================= */
function csvUrl(url) {
  const gid = url.match(/gid=(\d+)/)?.[1];
  return url.replace(
    /\/edit.*$/,
    `/gviz/tq?tqx=out:csv${gid ? `&gid=${gid}` : ""}`
  );
}

function parseSheetDate(str) {
  if (!str) return null;
  const m = str.match(
    /^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2})/
  );
  if (!m) return null;

  return new Date(
    m[3], m[1] - 1, m[2],
    m[4], m[5], m[6]
  );
}

function sameDay(d1, d2) {
  return d1.getFullYear() === d2.getFullYear() &&
         d1.getMonth() === d2.getMonth() &&
         d1.getDate() === d2.getDate();
}

function parseCsvCleaned(text) {
  text = text.replace(/"/g, "");
  return text
    .split(/\r?\n/)
    .map(r => r.split(",").map(c => c.trim()))
    .filter(r => r.length > 1);
}

function formatPhone(phone) {
  const d = phone.replace(/\D/g, "");
  return d.length === 10
    ? `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`
    : phone;
}

/* ================= MAIN ================= */
const datePicker = document.getElementById("datePicker");
const messageInput = document.getElementById("message");
const greetingInput = document.getElementById("greeting");

const DEFAULT_GREETING = "Hey";
const DEFAULT_MESSAGE = "It was great having you in worship with us today.\nI look forward to getting to know you.";

greetingInput.value = localStorage.getItem("vm_greeting") || DEFAULT_GREETING;
messageInput.value = localStorage.getItem("vm_message") || DEFAULT_MESSAGE;

messageInput.addEventListener("input", () =>
  localStorage.setItem("vm_message", messageInput.value)
);
greetingInput.addEventListener("input", () =>
  localStorage.setItem("vm_greeting", greetingInput.value)
);

window.addEventListener("DOMContentLoaded", () => {
  const today = new Date();
  datePicker.value =
    today.getFullYear() + '-' +
    String(today.getMonth()+1).padStart(2,'0') + '-' +
    String(today.getDate()).padStart(2,'0');

  if (localStorage.getItem("vm_signed_in") === "yes") {
    loadVisitors();
  }
});

datePicker.addEventListener("change", () => {
  if (localStorage.getItem("vm_signed_in") === "yes") loadVisitors();
});

async function loadVisitors() {
  const list = document.getElementById("visitorList");

  if (localStorage.getItem("vm_signed_in") !== "yes") {
    list.innerHTML = "Please sign in first.";
    return;
  }

  list.innerHTML = "Loading...";

  const dateValue = datePicker.value;
  if (!dateValue) {
    list.innerHTML = "Select a date";
    return;
  }

  const [y, m, d] = dateValue.split("-").map(Number);
  const selected = new Date(y, m - 1, d);

  const res = await fetch(csvUrl(SHEET_URL));
  const rows = parseCsvCleaned(await res.text());

  list.innerHTML = "";

  rows.slice(1).forEach(cols => {
    if (cols.length < 12) return;

    const visitDate = parseSheetDate(cols[0]);
    if (!visitDate || !sameDay(visitDate, selected)) return;

    const first = cols[1];
    const last = cols[2];
    const phone = cols[3];
    const decade = cols[7];
    const smsAllowed = cols[4].toLowerCase() !== "no";

    const children = [];
    if (cols[11].toLowerCase() === "yes") {
      for (let i = 12; i < cols.length; i += 2) {
        if (cols[i] && cols[i+1]) {
          children.push(`${cols[i]} (${cols[i+1]})`);
        }
      }
    }

    const div = document.createElement("div");
    div.className = "visitor";

    div.innerHTML = `
      <div class="visitor-info">
        <strong>${first} ${last}</strong> <span style="font-size:12px">(${decade})</span><br>
        ${formatPhone(phone)}
        ${children.length ? `<div class="children">Children: ${children.join(", ")}</div>` : ""}
        <div class="children" style="color: green;">${cols[9]}, ${cols[10]}</div>
      </div>
    `;

    const btn = document.createElement("button");
    btn.textContent = "SMS";
    btn.className = smsAllowed ? "sms-enabled" : "sms-disabled";
    btn.disabled = !smsAllowed;
    btn.onclick = () => sendSms(phone, first);

    div.appendChild(btn);
    list.appendChild(div);
  });

  if (!list.children.length) list.innerHTML = "No visitors found for this date";
}

function sendSms(phone, first) {
  const body = encodeURIComponent(`${greetingInput.value} ${first}, ${messageInput.value}`);
  window.location.href = `sms:${phone}?body=${body}`;
}
</script>

<!-- ===================================================== -->
<!-- DEBUGGING CODE: Unregister ALL service workers         -->
<!-- This removes old SW installs interfering with install  -->
<!-- ===================================================== -->
<script>
(async () => {
  if ("serviceWorker" in navigator) {
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const reg of regs) await reg.unregister();
    console.log("All service workers unregistered.");
  }
})();
</script>

</body>
</html>
