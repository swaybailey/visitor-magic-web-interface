<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Visitor Magic</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 16px;
    background: #f5f5f5;
  }

  header {
    display: flex;
    align-items: center;
    margin-bottom: 16px;
  }

  header h1 {
    flex: 1;
    margin: 0;
    font-size: 24px;
    text-align: center;
  }

  header a, .header-plus, #sheetIcon {
    text-decoration: none;
    font-size: 20px;
    margin: 0 8px;
  }

  .header-plus {
    margin-left: auto;
  }

  #userIconBtn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    margin-right: 8px;
    background-size: cover;
    background-position: center;
    background-color: #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #333;
  }

  .controls {
    margin-bottom: 16px;
  }

  .controls label {
    font-weight: bold;
    display: block;
    margin-top: 8px;
  }

  input[type="date"] {
    width: 150px;
    padding: 6px;
    font-size: 16px;
  }

  input[type="text"], textarea {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    font-size: 16px;
    display: block;
  }

  .visitor {
    background: white;
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .visitor-info {
    flex: 1;
  }

  .children {
    color: red;
    font-size: 13px;
    margin-top: 4px;
  }

  .sms-enabled {
    background: #47b80f;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 8px 10px;
  }

  .sms-disabled {
    background: #ccc;
    color: #666;
    border: none;
    border-radius: 4px;
    padding: 8px 10px;
  }

  #statusLine {
    margin-top: 10px;
    font-size: 14px;
    color: #444;
  }
</style>
</head>

<body>

<header>
  <button id="userIconBtn">Login</button>
  <h1>Visitor Magic</h1>
  <a href="https://docs.google.com/spreadsheets/d/1HRd1uKlvqqRveJN7SCdYh9IOu8cU0ygRaMYEG3XL6eQ/edit?gid=671174622"
     target="_blank" id="sheetIcon">ðŸ“„</a>
  <a href="addcontact.html" class="header-plus">âž•</a>
</header>

<div class="controls" id="appControls" style="display:none;">
  <label for="datePicker">Date</label>
  <input type="date" id="datePicker">

  <label for="greeting">Greeting</label>
  <input type="text" id="greeting">

  <label for="message">Message</label>
  <textarea id="message" rows="4"></textarea>
</div>

<div id="visitorList"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
const GOOGLE_CLIENT_ID = "651012310033-dbj2vvf3evf9aomj577621ddhked2uvn.apps.googleusercontent.com";
const SPREADSHEET_ID = "1HRd1uKlvqqRveJN7SCdYh9IOu8cU0ygRaMYEG3XL6eQ";
const SHEET_RANGE = "Form Responses 1!A:V";

let accessToken = null;
let tokenClient = null;

const userIconBtn = document.getElementById("userIconBtn");

function initTokenClient() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: "https://www.googleapis.com/auth/spreadsheets.readonly",
    callback: (tokenResponse) => {
      if (!tokenResponse || !tokenResponse.access_token) return;
      accessToken = tokenResponse.access_token;
      localStorage.setItem("vm_access_token", accessToken);
      fetchUserProfile();
      showAppUI(true);
    }
  });
}

userIconBtn.addEventListener("click", () => {
  if (accessToken) {
    accessToken = null;
    localStorage.removeItem("vm_access_token");
    userIconBtn.textContent = "Login";
    userIconBtn.style.backgroundImage = "";
    userIconBtn.innerHTML = "Login"; // restore text inside circle
    showAppUI(false);
    document.getElementById("visitorList").innerHTML = "";
  } else {
    if (!tokenClient) initTokenClient();
    tokenClient.requestAccessToken({ prompt: "consent" });
  }
});

function fetchUserProfile() {
  if (!accessToken) return;
  fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json", {
    headers: { "Authorization": `Bearer ${accessToken}` }
  })
  .then(res => res.json())
  .then(data => {
    const pic = data.picture || '';
    if (pic) {
      userIconBtn.style.backgroundImage = `url(${pic})`;
      userIconBtn.textContent = "";
    } else {
      // fallback to generic human-head icon
      userIconBtn.style.backgroundImage = "url('https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_placeholder.png')";
      userIconBtn.textContent = "";
    }
    userIconBtn.title = `Signed in as ${data.name || "User"}`;
    showAppUI(true);
    loadVisitors();
  })
  .catch(() => {
    userIconBtn.textContent = "Login";
    userIconBtn.style.backgroundImage = "";
    showAppUI(true);
  });
}

function showAppUI(show) {
  document.getElementById("appControls").style.display = show ? "block" : "none";
}

window.addEventListener("DOMContentLoaded", () => {
  const savedToken = localStorage.getItem("vm_access_token");
  if (savedToken) {
    accessToken = savedToken;
    fetchUserProfile();
  }
});

// ========== Existing Visitor Functions ==========

function parseSheetDate(str) {
  if (!str) return null;
  const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2})/);
  if (!m) return null;
  return new Date(m[3], m[1]-1, m[2], m[4], m[5], m[6]);
}

function sameDay(d1,d2){
  return d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth() && d1.getDate()===d2.getDate();
}

function formatPhone(phone){
  const d=(phone||"").replace(/\D/g,"");
  return d.length===10?`(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`:(phone||"");
}

// MAIN UI
const datePicker = document.getElementById("datePicker");
const messageInput = document.getElementById("message");
const greetingInput = document.getElementById("greeting");

const DEFAULT_GREETING = "Hey";
const DEFAULT_MESSAGE = "It was great having you in worship with us today.\nI look forward to getting to know you.";

greetingInput.value = localStorage.getItem("vm_greeting") || DEFAULT_GREETING;
messageInput.value = localStorage.getItem("vm_message") || DEFAULT_MESSAGE;

messageInput.addEventListener("input", ()=>localStorage.setItem("vm_message", messageInput.value));
greetingInput.addEventListener("input", ()=>localStorage.setItem("vm_greeting", greetingInput.value));

window.addEventListener("DOMContentLoaded", () => {
  const today = new Date();
  datePicker.value = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
});

datePicker.addEventListener("change", ()=>{if(accessToken) loadVisitors();});

async function fetchSheetValues(){
  if(!accessToken) throw new Error("Not signed in / no access token.");
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(SHEET_RANGE)}`;
  const res=await fetch(url,{headers:{"Authorization":`Bearer ${accessToken}`}});
  if(!res.ok) throw new Error(`Sheets API error (${res.status})`);
  const data=await res.json();
  return data.values||[];
}

async function loadVisitors(){
  const list=document.getElementById("visitorList");
  list.innerHTML="Loading...";
  const dateValue=datePicker.value;
  if(!dateValue){list.innerHTML="Select a date"; return;}
  const [y,m,d]=dateValue.split("-").map(Number);
  const selected=new Date(y,m-1,d);

  let rows;
  try{rows=await fetchSheetValues();} catch(e){list.innerHTML="Error loading sheet"; return;}
  list.innerHTML="";

  rows.slice(1).forEach(cols=>{
    if(!cols||cols.length<12) return;
    const visitDate=parseSheetDate(cols[0]);
    if(!visitDate||!sameDay(visitDate,selected)) return;
    const first=cols[1]||"", last=cols[2]||"", phone=cols[3]||"", decade=cols[7]||"", smsAllowed=(cols[4]||"").toLowerCase()!=="no";
    const children=[];
    if((cols[11]||"").toLowerCase()==="yes"){
      for(let i=12;i<cols.length;i+=2){ const name=cols[i],age=cols[i+1]; if(name&&age) children.push(`${name} (${age})`); }
    }
    const div=document.createElement("div"); div.className="visitor";
    const info=document.createElement("div"); info.className="visitor-info";
    info.innerHTML=`<strong>${first} ${last}</strong> <span style="font-size:12px;font-weight:normal;">(${decade})</span><br>${formatPhone(phone)}${children.length?`<div class="children">Children: ${children.join(", ")}</div>`:""}<div class="children" style="color:green;">${(cols[9]||"")}, ${(cols[10]||"")}</div>`;
    const btn=document.createElement("button"); btn.textContent="SMS"; btn.className=smsAllowed?"sms-enabled":"sms-disabled"; btn.disabled=!smsAllowed;
    btn.addEventListener("click",()=>sendSms(phone,first));
    div.append(info,btn); list.appendChild(div);
  });

  if(!list.children.length) list.innerHTML="No visitors found for this date";
}

// SMS
function sendSms(phone,first){ const body=encodeURIComponent(`${greetingInput.value} ${first}, ${messageInput.value}`); window.location.href=`sms:${phone}?body=${body}`; }

</script>

</body>
</html>
