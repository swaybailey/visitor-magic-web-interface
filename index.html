<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visitor Magic</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }
    #top-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        position: relative;
    }
    #sheet-link {
        position: absolute;
        left: 0;
        cursor: pointer;
        font-size: 24px;
        color: #1976D2;
        text-decoration: none;
    }
    h1 {
        margin: 0;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
    }
    #controls {
        margin-bottom: 20px;
    }
    #visitors {
        margin-top: 20px;
    }
    .visitor {
        border-bottom: 1px solid #ccc;
        padding: 8px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .visitor-info {
        flex: 1;
    }
    .phone {
        color: red;
        margin: 4px 0;
    }
    .children {
        color: red;
        font-style: italic;
        margin-top: 2px;
    }
    .sms-button {
        background-color: #47B80F;
        color: white;
        border: none;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 12px;
        border-radius: 4px;
    }
</style>
</head>
<body>

<div id="top-bar">
    <a id="sheet-link" href="https://docs.google.com/spreadsheets/d/1HRd1uKlvqqRveJN7SCdYh9IOu8cU0ygRaMYEG3XL6eQ/edit?gid=671174622" target="_blank">ðŸ”—</a>
    <h1>Visitor Magic</h1>
</div>

<div id="controls">
    <label for="visit-date">Select date: </label>
    <input type="date" id="visit-date" />
    <button id="load-visitors">Load Visitors</button>
</div>

<div id="visitors"></div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/1HRd1uKlvqqRveJN7SCdYh9IOu8cU0ygRaMYEG3XL6eQ/gviz/tq?tqx=out:csv&gid=671174622";

function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    const header = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
    const rows = lines.slice(1).map(line => {
        const parts = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(p => p.replace(/"/g, '').trim());
        const row = {};
        header.forEach((h, i) => row[h] = parts[i] || '');
        return row;
    });
    return rows;
}

function formatDate(date) {
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const dd = String(date.getDate()).padStart(2, '0');
    const yyyy = date.getFullYear();
    return `${yyyy}-${mm}-${dd}`;
}

function filterVisitorsByDate(visitors, selectedDate) {
    return visitors.filter(visitor => {
        const visitDate = new Date(visitor['Timestamp']);
        const yyyy = visitDate.getFullYear();
        const mm = String(visitDate.getMonth() + 1).padStart(2, '0');
        const dd = String(visitDate.getDate()).padStart(2, '0');
        const visitorDate = `${yyyy}-${mm}-${dd}`;
        return visitorDate === selectedDate;
    });
}

function cleanPhoneNumber(phone) {
    const digits = phone.replace(/\D/g, '');
    return digits.length === 10
        ? `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6,10)}`
        : phone;
}

function getChildrenInfo(visitor) {
    const children = [];
    for (let i = 0; i < 5; i++) {
        const nameKey = `Child's name${i > 0 ? `_${i}` : ''}`;
        const ageKey = `age${i > 0 ? `_${i}` : ''}`;
        if (visitor[nameKey] && visitor[ageKey]) {
            children.push(`${visitor[nameKey]} (${visitor[ageKey]})`);
        }
    }
    return children.join(', ');
}

async function loadVisitors() {
    const dateInput = document.getElementById('visit-date').value;
    if (!dateInput) {
        alert('Please select a date.');
        return;
    }
    const res = await fetch(csvUrl);
    const text = await res.text();
    const visitors = parseCSV(text);
    const filtered = filterVisitorsByDate(visitors, dateInput);

    const container = document.getElementById('visitors');
    container.innerHTML = '';
    if (filtered.length === 0) {
        container.innerHTML = '<p>No visitors found</p>';
        return;
    }

    filtered.forEach(visitor => {
        const div = document.createElement('div');
        div.className = 'visitor';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'visitor-info';
        infoDiv.innerHTML = `
            <div>Name: ${visitor['First Name']} ${visitor['Last Name']}</div>
            <div class="phone">Phone: ${cleanPhoneNumber(visitor['Phone Number'])}</div>
        `;

        const childrenInfo = getChildrenInfo(visitor);
        if (childrenInfo) {
            const childrenDiv = document.createElement('div');
            childrenDiv.className = 'children';
            childrenDiv.textContent = `Children: ${childrenInfo}`;
            infoDiv.appendChild(childrenDiv);
        }

        const smsBtn = document.createElement('button');
        smsBtn.className = 'sms-button';
        smsBtn.textContent = 'SMS';
        if (visitor['Do you receive texts at this number'].toLowerCase() === 'no') {
            smsBtn.disabled = true;
            smsBtn.style.backgroundColor = 'red';
        } else {
            smsBtn.onclick = () => {
                const msg = `Hi ${visitor['First Name']}, it was great having you in worship today!`;
                window.location.href = `sms:${cleanPhoneNumber(visitor['Phone Number'])}?body=${encodeURIComponent(msg)}`;
            };
        }

        div.appendChild(infoDiv);
        div.appendChild(smsBtn);

        container.appendChild(div);
    });
}

document.getElementById('load-visitors').addEventListener('click', loadVisitors);

// Set default date to today
document.getElementById('visit-date').value = formatDate(new Date());
</script>

</body>
</html>
