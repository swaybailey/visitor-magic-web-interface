<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Contact</title>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    header {
      position: relative;
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    header h1 {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      font-size: 24px;
    }
    .icon-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
    }
    .header-left {
      margin-right: auto;
    }
    .header-right {
      margin-left: auto;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      overflow: hidden;
      border: 1px solid #ccc;
      background: white;
    }
    .header-right img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* ===== Date Range ===== */
    .date-range {
      display: none;
      gap: 8px;
      margin-bottom: 12px;
    }
    .date-range.show {
      display: flex;
    }
    .date-range input {
      flex: 1;
      padding: 8px;
      font-size: 16px;
    }
    /* ===== Content ===== */
    .section-label {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      text-align: center;
    }
    .visitor-btn {
      display: block;
      width: 70%;
      padding: 10px;
      margin: 0 auto 8px;
      font-size: 16px;
      background: #47b80f;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #status {
      text-align: center;
      color: #555;
      font-size: 14px;
      margin: 8px 0 16px;
    }
  </style>
</head>
<body>

<header>
  <button class="icon-button header-left" onclick="history.back()" title="Back">⬅️</button>
  <h1>Add Contact</h1>
  <button class="icon-button header-right" id="userBtn" title="Sign in / out">
    <img id="userIcon" src="genuser.jpg" alt="User">
  </button>
</header>

<div id="dateRange" class="date-range">
  <input type="date" id="startDate">
  <input type="date" id="endDate">
</div>

<div id="status">Click avatar to sign in</div>
<div id="label" class="section-label"></div>
<div id="visitorButtons">Please sign in to load visitors</div>

<script>
// ────────────────────────────────────────────────
// CONFIG – same as your main file
// ────────────────────────────────────────────────
const GOOGLE_CLIENT_ID = "651012310033-dbj2vvf3evf9aomj577621ddhked2uvn.apps.googleusercontent.com";
const SPREADSHEET_ID  = "1HRd1uKlvqqRveJN7SCdYh9IOu8cU0ygRaMYEG3XL6eQ";
const SHEET_RANGE     = "Form Responses 1!A:V";

let accessToken = null;
let tokenClient = null;

const userIcon = document.getElementById("userIcon");
const statusEl  = document.getElementById("status");

// ────────────────────────────────────────────────
// Helpers
// ────────────────────────────────────────────────
function setStatus(msg) {
  statusEl.textContent = msg || "";
}

function updateUserIcon(profile) {
  userIcon.src = profile?.picture || "genuser.jpg";
}

function initTokenClient() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",
    callback: async (tokenResponse) => {
      if (!tokenResponse?.access_token) {
        setStatus("Sign-in failed");
        return;
      }
      accessToken = tokenResponse.access_token;
      localStorage.setItem("vm_access_token", accessToken);
      setStatus("");
      try {
        const res = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        const profile = await res.json();
        updateUserIcon(profile);
      } catch {
        updateUserIcon();
      }
      loadVisitors();
    }
  });
}

// ────────────────────────────────────────────────
// Auth flow
// ────────────────────────────────────────────────
document.getElementById("userBtn").addEventListener("click", () => {
  if (!accessToken) {
    if (!tokenClient) initTokenClient();
    tokenClient.requestAccessToken({ prompt: "consent" });
  } else {
    accessToken = null;
    localStorage.removeItem("vm_access_token");
    updateUserIcon();
    setStatus("Signed out. Click avatar to sign in.");
    document.getElementById("visitorButtons").innerHTML = "Please sign in to load visitors";
  }
});

// Restore session
window.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("vm_access_token");
  if (saved) {
    accessToken = saved;
    setStatus("Loading...");
    fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
      headers: { Authorization: `Bearer ${accessToken}` }
    })
      .then(r => r.json())
      .then(updateUserIcon)
      .catch(updateUserIcon);
    loadVisitors();
  } else {
    updateUserIcon();
  }
});

// ────────────────────────────────────────────────
// Sheet fetching (same as main app)
// ────────────────────────────────────────────────
async function fetchSheetValues() {
  if (!accessToken) throw new Error("Not signed in");
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(SHEET_RANGE)}`;
  const res = await fetch(url, {
    headers: { Authorization: `Bearer ${accessToken}` }
  });
  if (!res.ok) throw new Error(`API error ${res.status}`);
  const data = await res.json();
  return data.values || [];
}

// ────────────────────────────────────────────────
// Date range + visitor loading
// ────────────────────────────────────────────────
const startInput = document.getElementById("startDate");
const endInput   = document.getElementById("endDate");
const label      = document.getElementById("label");
const buttonsDiv = document.getElementById("visitorButtons");
const dateRange  = document.getElementById("dateRange");

document.getElementById("calendarToggle").addEventListener("click", () => {
  dateRange.classList.toggle("show");
});

function initDates() {
  const end   = new Date();
  const start = new Date();
  start.setDate(end.getDate() - 30);
  startInput.value = start.toISOString().split("T")[0];
  endInput.value   = end.toISOString().split("T")[0];
}

function formatDate(d) {
  return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
}

initDates();
startInput.addEventListener("change", loadVisitors);
endInput.addEventListener("change", loadVisitors);

async function loadVisitors() {
  if (!accessToken) {
    buttonsDiv.innerHTML = "Please sign in to load visitors";
    return;
  }

  buttonsDiv.innerHTML = "Loading...";
  const start = new Date(startInput.value);
  const end   = new Date(endInput.value);
  end.setHours(23,59,59,999);

  label.textContent = `Visitors from ${formatDate(start)} to ${formatDate(end)}`;

  let rows;
  try {
    rows = await fetchSheetValues();
  } catch (err) {
    buttonsDiv.innerHTML = "Error loading data";
    console.error(err);
    return;
  }

  buttonsDiv.innerHTML = "";
  let count = 0;

  rows.slice(1).forEach(cols => {
    if (cols.length < 12) return;
    const visitDate = new Date(cols[0]);
    if (isNaN(visitDate) || visitDate < start || visitDate > end) return;

    const first   = cols[1]?.trim() || "";
    const last    = cols[2]?.trim() || "";
    if (!first || !last) return;

    const phone   = (cols[3] || "").trim();
    const email   = (cols[5] || "").trim();
    const address = [cols[8], cols[9], cols[10]].filter(Boolean).join(", ").trim();

    const hasChildren = (cols[11] || "").toLowerCase() === "yes";
    let children = [];
    if (hasChildren) {
      for (let i = 12; i < cols.length; i += 2) {
        const name = cols[i]?.trim();
        const age  = cols[i+1]?.trim();
        if (name) children.push(age ? `${name} (${age})` : name);
      }
    }

    const visitDateStr = cols[0].split(" ")[0]; // keep original string format

    const noteLines = [
      `Date of first visit: ${visitDateStr}`,
      ...(children.length ? [`Children: ${children.join(", ")}`] : []),
      "Added automatically from VisitorMagicWeb"
    ];
    const note = noteLines.join("\\n");

    const btn = document.createElement("button");
    btn.className = "visitor-btn";
    btn.textContent = `${first} ${last}`;
    btn.onclick = () => {
      const vcfLines = [
        "BEGIN:VCARD",
        "VERSION:3.0",
        `N:${last};${first};;;`,
        `FN:${first} ${last}`,
        phone   ? `TEL;TYPE=CELL:${phone}` : "",
        address ? `ADR:;;${address};;;;` : "",
        email   ? `EMAIL:${email}` : "",
        `NOTE:${note}`,
        "END:VCARD"
      ].filter(Boolean).join("\n");

      const blob = new Blob([vcfLines], { type: "text/vcard" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${first}_${last}.vcf`;
      a.click();
      URL.revokeObjectURL(url);
    };

    buttonsDiv.appendChild(btn);
    count++;
  });

  if (count === 0) {
    buttonsDiv.innerHTML = "No visitors found in this date range";
  }
}
</script>
</body>
</html>
