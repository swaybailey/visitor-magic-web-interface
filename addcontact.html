<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Contact</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    header {
      position: relative;
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    header h1 {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      font-size: 24px;
    }
    .icon-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
    }
    .header-left {
      margin-right: auto;
    }
    .header-right {
      margin-left: auto;
    }
    /* ===== Date Range ===== */
    .date-range {
      display: none;
      gap: 8px;
      margin-bottom: 12px;
    }
    .date-range.show {
      display: flex;
    }
    .date-range input {
      flex: 1;
      padding: 8px;
      font-size: 16px;
    }
    /* ===== Content ===== */
    .section-label {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      text-align: center;
    }
    .visitor-btn {
      display: block;
      width: 70%;
      padding: 10px;
      margin: 0 auto 8px;
      font-size: 16px;
      background: #47b80f;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #status {
      text-align: center;
      color: #d32f2f;
      font-size: 14px;
      margin: 8px 0 16px;
    }
  </style>
</head>
<body>

<header>
  <button class="icon-button header-left" onclick="history.back()" title="Back">‚¨ÖÔ∏è</button>
  <h1>Add Contact</h1>
  <button class="icon-button header-right" id="calendarToggle" title="Select Date Range">üìÖ</button>
</header>

<div id="dateRange" class="date-range">
  <input type="date" id="startDate">
  <input type="date" id="endDate">
</div>

<div id="status"></div>
<div id="label" class="section-label"></div>
<div id="visitorButtons">Loading...</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CONFIG ‚Äì same as main file
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SPREADSHEET_ID  = "1HRd1uKlvqqRveJN7SCdYh9IOu8cU0ygRaMYEG3XL6eQ";
const SHEET_RANGE     = "Form Responses 1!A:V";

let accessToken = localStorage.getItem("vm_access_token");

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Sheet fetching (same as main app)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchSheetValues() {
  if (!accessToken) throw new Error("No access token found. Please sign in from the main page first.");
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(SHEET_RANGE)}`;
  const res = await fetch(url, {
    headers: { Authorization: `Bearer ${accessToken}` }
  });
  if (!res.ok) throw new Error(`API error ${res.status}`);
  const data = await res.json();
  return data.values || [];
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Date range + visitor loading
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const startInput = document.getElementById("startDate");
const endInput   = document.getElementById("endDate");
const label      = document.getElementById("label");
const buttonsDiv = document.getElementById("visitorButtons");
const dateRange  = document.getElementById("dateRange");
const statusEl   = document.getElementById("status");

document.getElementById("calendarToggle").addEventListener("click", () => {
  dateRange.classList.toggle("show");
});

function formatDate(d) {
  if (!(d instanceof Date) || isNaN(d)) return "‚Äî";
  return d.toLocaleDateString();  
}

// No auto-init of dates ‚Äî leave inputs empty so user can pick any range

startInput.addEventListener("change", loadVisitors);
endInput.addEventListener("change", loadVisitors);

async function loadVisitors() {
  if (!accessToken) {
    statusEl.textContent = "No sign-in found. Please go back to the main page and sign in first.";
    buttonsDiv.innerHTML = "";
    return;
  }

  statusEl.textContent = "";

  const startVal = startInput.value;
  const endVal   = endInput.value;

  if (!startVal || !endVal) {
    label.textContent = "Please select a start and end date";
    buttonsDiv.innerHTML = "";
    return;
  }

  const start = new Date(startVal);
  const end   = new Date(endVal);
  if (isNaN(start) || isNaN(end)) {
    label.textContent = "Invalid date range selected";
    buttonsDiv.innerHTML = "";
    return;
  }
  end.setHours(23,59,59,999);

  label.textContent = `Visitors from ${formatDate(start)} to ${formatDate(end)}`;

  buttonsDiv.innerHTML = "Loading...";

  let rows;
  try {
    rows = await fetchSheetValues();
  } catch (err) {
    buttonsDiv.innerHTML = "Error loading data from sheet";
    console.error(err);
    return;
  }

  buttonsDiv.innerHTML = "";
  let count = 0;

  rows.slice(1).forEach(cols => {
    if (cols.length < 12) return;
    const visitDate = new Date(cols[0]);
    if (isNaN(visitDate) || visitDate < start || visitDate > end) return;

    const first   = cols[1]?.trim() || "";
    const last    = cols[2]?.trim() || "";
    if (!first || !last) return;

    const phone   = (cols[3] || "").trim();
    const email   = (cols[5] || "").trim();
    const address = [cols[8], cols[9], cols[10]].filter(Boolean).join(", ").trim();

    const hasChildren = (cols[11] || "").toLowerCase() === "yes";
    let children = [];
    if (hasChildren) {
      for (let i = 12; i < cols.length; i += 2) {
        const name = cols[i]?.trim();
        const age  = cols[i+1]?.trim();
        if (name) children.push(age ? `${name} (${age})` : name);
      }
    }

    const visitDateStr = cols[0].split(" ")[0] || formatDate(visitDate);

    const noteLines = [
      `Date of first visit: ${visitDateStr}`,
      ...(children.length ? [`Children: ${children.join(", ")}`] : []),
      "Added automatically from VisitorMagicWeb"
    ];
    const note = noteLines.join("\\n");

    const btn = document.createElement("button");
    btn.className = "visitor-btn";
    btn.textContent = `${first} ${last}`;
    btn.onclick = () => {
      const vcfLines = [
        "BEGIN:VCARD",
        "VERSION:3.0",
        `N:${last};${first};;;`,
        `FN:${first} ${last}`,
        phone   ? `TEL;TYPE=CELL:${phone}` : "",
        address ? `ADR:;;${address};;;;` : "",
        email   ? `EMAIL:${email}` : "",
        `NOTE:${note}`,
        "END:VCARD"
      ].filter(Boolean).join("\n");

      const blob = new Blob([vcfLines], { type: "text/vcard" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${first}_${last}.vcf`;
      a.click();
      URL.revokeObjectURL(url);
    };

    buttonsDiv.appendChild(btn);
    count++;
  });

  if (count === 0) {
    buttonsDiv.innerHTML = "No visitors found in this date range";
  }
}

// Initial load ‚Äî will prompt for dates since none are pre-filled
loadVisitors();
</script>
</body>
</html>
